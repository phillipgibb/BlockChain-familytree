//var solc = require('solc');
var fs = require('fs');
var contract = require("truffle-contract");

//import { default as Web3} from 'web3';
import { default as CryptoJS } from 'crypto-js';
export default class  FamilyTreeWrapper {

  constructor(web3){
  this.web3 = web3
  this.familyTreeABI = '[{"constant":false,"inputs":[{"name":"childId","type":"int128"},{"name":"name","type":"string"},{"name":"gender","type":"string"},{"name":"dateOfBirth","type":"string"},{"name":"dateOfDeath","type":"string"}],"name":"addMother","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"parentId","type":"int128"},{"name":"childId","type":"int128"}],"name":"hasThisChild","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"childId","type":"int128"},{"name":"name","type":"string"},{"name":"gender","type":"string"},{"name":"dateOfBirth","type":"string"},{"name":"dateOfDeath","type":"string"}],"name":"addFather","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"fatherId","type":"int128"},{"name":"motherId","type":"int128"},{"name":"name","type":"string"},{"name":"gender","type":"string"},{"name":"dateOfBirth","type":"string"},{"name":"dateOfDeath","type":"string"}],"name":"addChild","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getNumberOfFamilyMembers","outputs":[{"name":"","type":"int128"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"id","type":"int128"}],"name":"getNode","outputs":[{"name":"name","type":"string"},{"name":"gender","type":"string"},{"name":"spouseId","type":"int128"},{"name":"dateOfBirth","type":"string"},{"name":"dateOfDeath","type":"string"},{"name":"motherId","type":"int128"},{"name":"fatherId","type":"int128"},{"name":"childrenIds","type":"int128[]"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"id","type":"int128"},{"name":"dateOfDeath","type":"string"}],"name":"funeral","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"name","type":"string"},{"name":"gender","type":"string"},{"name":"dateOfBirth","type":"string"},{"name":"dateOfDeath","type":"string"}],"name":"addFamilyMember","outputs":[{"name":"newId","type":"int128"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"otherSpouseId","type":"int128"},{"name":"name","type":"string"},{"name":"gender","type":"string"},{"name":"dateOfBirth","type":"string"},{"name":"dateOfDeath","type":"string"}],"name":"addSpouse","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"spouseId","type":"int128"},{"name":"otherSpouseId","type":"int128"}],"name":"divorse","outputs":[],"payable":false,"type":"function"},{"inputs":[{"name":"name","type":"string"},{"name":"gender","type":"string"},{"name":"dateOfBirth","type":"string"}],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"fromAddress","type":"address"},{"indexed":false,"name":"toAddress","type":"address"},{"indexed":false,"name":"linkId","type":"uint256"}],"name":"FamilyCreated","type":"event"}]';
  this.familyTreeByteCode = "0x606060405234156200001057600080fd5b60405162001d8938038062001d898339810160405280805182019190602001805182019190602001805190910190505b6200004a6200045c565b600180546001608060020a031916905560008080526020527fad3228b676f7d3cd4284a5443f17f1962b36e491b30a40b2405849e597ba5fb561014060405190810160405290816000820160009054906101000a9004600f0b600f0b600f0b8152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156200014a5780601f106200011e576101008083540402835291602001916200014a565b820191906000526020600020905b8154815290600101906020018083116200012c57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015620001f05780601f10620001c457610100808354040283529160200191620001f0565b820191906000526020600020905b815481529060010190602001808311620001d257829003601f168201915b505050505081526020016003820160009054906101000a9004600f0b600f0b600f0b8152602001600482018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015620002b35780601f106200028757610100808354040283529160200191620002b3565b820191906000526020600020905b8154815290600101906020018083116200029557829003601f168201915b50505050508152602001600582018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015620003595780601f106200032d5761010080835404028352916020019162000359565b820191906000526020600020905b8154815290600101906020018083116200033b57829003601f168201915b505050505081526020016006820160009054906101000a9004600f0b600f0b600f0b81526020016006820160109054906101000a9004600f0b600f0b600f0b815260200160078201548152602001600882018054806020026020016040519081016040528092919081815260200182805480156200041d57602002820191906000526020600020906000905b82829054906101000a9004600f0b600f0b81526020019060100190602082600f01049283019260010382029150808411620003e55790505b505050919092525050506020810185905260001960608201526000808252610100820152604081018490526080810183905290505b50505050620004fb565b61014060405190810160405260008152602081016200047a620004d7565b815260200162000489620004d7565b8152600060208201526040016200049f620004d7565b8152602001620004ae620004d7565b8152600060208201819052604082018190526060820152608001620004d2620004d7565b905290565b60206040519081016040526000815290565b60206040519081016040526000815290565b61187e806200050b6000396000f300606060405236156100a15763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416631cb3167881146100a65780632ce5cac1146101c757806358f46edc146101fc5780635b93a28c1461031d57806360fbf745146104485780636d244b691461047457806372e8b274146106b1578063a4ba91a61461070c578063b3388fe71461083c578063c357b1111461095d575b600080fd5b34156100b157600080fd5b6101c560048035600f0b9060446024803590810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284375094965061098095505050505050565b005b34156101d257600080fd5b6101e8600435600f90810b90602435900b610a3a565b604051901515815260200160405180910390f35b341561020757600080fd5b6101c560048035600f0b9060446024803590810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f016020809104026020016040519081016040528181529291906020840183838082843750949650610e4f95505050505050565b005b341561032857600080fd5b6101c560048035600f90810b916024803590920b9160649060443590810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f016020809104026020016040519081016040528181529291906020840183838082843750949650610f0995505050505050565b005b341561045357600080fd5b61045b6110b0565b604051600f91820b90910b815260200160405180910390f35b341561047f57600080fd5b61048d600435600f0b6110ba565b60405180806020018060200189600f0b600f0b8152602001806020018060200188600f0b600f0b815260200187600f0b600f0b81526020018060200186810386528e818151815260200191508051906020019080838360005b838110156104ff5780820151818401525b6020016104e6565b50505050905090810190601f16801561052c5780820380516001836020036101000a031916815260200191505b5086810385528d818151815260200191508051906020019080838360005b838110156105635780820151818401525b60200161054a565b50505050905090810190601f1680156105905780820380516001836020036101000a031916815260200191505b5086810384528b818151815260200191508051906020019080838360005b838110156105c75780820151818401525b6020016105ae565b50505050905090810190601f1680156105f45780820380516001836020036101000a031916815260200191505b5086810383528a818151815260200191508051906020019080838360005b8381101561062b5780820151818401525b602001610612565b50505050905090810190601f1680156106585780820380516001836020036101000a031916815260200191505b50868103825287818151815260200191508051906020019060200280838360005b838110156106925780820151818401525b602001610679565b505050509050019d505050505050505050505050505060405180910390f35b34156106bc57600080fd5b6101c560048035600f0b9060446024803590810190830135806020601f820181900481020160405190810160405281815292919060208401838380828437509496506114e495505050505050565b005b341561071757600080fd5b61045b60046024813581810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284375094965061151395505050505050565b604051600f91820b90910b815260200160405180910390f35b341561084757600080fd5b6101c560048035600f0b9060446024803590810190830135806020601f8201819004810201604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f01602080910402602001604051908101604052818152929190602084018383808284378201915050505050509190803590602001908201803590602001908080601f0160208091040260200160405190810160405281815292919060208401838380828437509496506115ed95505050505050565b005b341561096857600080fd5b6101c5600435600f90810b90602435900b611664565b005b600061098e85858585611513565b600f87810b810b60009081526020819052604080822060060180546fffffffffffffffffffffffffffffffff19166001608060020a0386860b9081169190911790915590920b815220600801805491925090600181016109ee83826116bf565b91600052602060002090600291828204019190066010025b88909190916101000a8154816001608060020a030219169083600f0b6001608060020a03160217905550505b505050505050565b6000610a446116f9565b60008060008087600f0b600f0b815260200190815260200160002061014060405190810160405290816000820160009054906101000a9004600f0b600f0b600f0b8152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b225780601f10610af757610100808354040283529160200191610b22565b820191906000526020600020905b815481529060010190602001808311610b0557829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610bc45780601f10610b9957610100808354040283529160200191610bc4565b820191906000526020600020905b815481529060010190602001808311610ba757829003601f168201915b505050505081526020016003820160009054906101000a9004600f0b600f0b600f0b8152602001600482018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c835780601f10610c5857610100808354040283529160200191610c83565b820191906000526020600020905b815481529060010190602001808311610c6657829003601f168201915b50505050508152602001600582018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d255780601f10610cfa57610100808354040283529160200191610d25565b820191906000526020600020905b815481529060010190602001808311610d0857829003601f168201915b505050505081526020016006820160009054906101000a9004600f0b600f0b600f0b81526020016006820160109054906101000a9004600f0b600f0b600f0b81526020016007820154815260200160088201805480602002602001604051908101604052809291908181526020018280548015610de757602002820191906000526020600020906000905b82829054906101000a9004600f0b600f0b81526020019060100190602082600f01049283019260010382029150808411610db05790505b50505050508152505092508261010001519150600090505b81811015610e415784600f0b8361012001518281518110610e1c57fe5b90602001906020020151600f0b1415610e385760019350610e46565b5b600101610dff565b600093505b50505092915050565b6000610e5d85858585611513565b600f87810b810b60009081526020819052604080822060060180546001608060020a0390811670010000000000000000000000000000000087870b928316021790915590920b815220600801805491925090600181016109ee83826116bf565b91600052602060002090600291828204019190066010025b88909190916101000a8154816001608060020a030219169083600f0b6001608060020a03160217905550505b505050505050565b6000610f1785858585611513565b9050610f238782610a3a565b1515610fe057600f87810b900b6000908152602081905260409020600801805460018101610f5183826116bf565b91600052602060002090600291828204019190066010025b8154600f85810b6001608060020a038181166101009590950a94850294810219909316939093179093558a830b80840b600090815260208190526040808220600701805460010190559390940b84529190922060060180549183167001000000000000000000000000000000000291909216179055505b610fea8682610a3a565b15156110a657600f86810b900b600090815260208190526040902060080180546001810161101883826116bf565b91600052602060002090600291828204019190066010025b81546101009190910a6001608060020a0381810219909216600f86810b84811693909302919091179093558a830b830b6000908152602081905260408082206007018054600101905591840b81522060060180546fffffffffffffffffffffffffffffffff1916928a900b909116919091179055505b5b50505050505050565b600154600f0b5b90565b6110c261176a565b6110ca61176a565b60006110d461176a565b6110dc61176a565b6000806110e761176a565b6110ef6116f9565b6000808b600f0b600f0b815260200190815260200160002061014060405190810160405290816000820160009054906101000a9004600f0b600f0b600f0b8152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156111ca5780601f1061119f576101008083540402835291602001916111ca565b820191906000526020600020905b8154815290600101906020018083116111ad57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561126c5780601f106112415761010080835404028352916020019161126c565b820191906000526020600020905b81548152906001019060200180831161124f57829003601f168201915b505050505081526020016003820160009054906101000a9004600f0b600f0b600f0b8152602001600482018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561132b5780601f106113005761010080835404028352916020019161132b565b820191906000526020600020905b81548152906001019060200180831161130e57829003601f168201915b50505050508152602001600582018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156113cd5780601f106113a2576101008083540402835291602001916113cd565b820191906000526020600020905b8154815290600101906020018083116113b057829003601f168201915b505050505081526020016006820160009054906101000a9004600f0b600f0b600f0b81526020016006820160109054906101000a9004600f0b600f0b600f0b8152602001600782015481526020016008820180548060200260200160405190810160405280929190818152602001828054801561148f57602002820191906000526020600020906000905b82829054906101000a9004600f0b600f0b81526020019060100190602082600f010492830192600103820291508084116114585790505b505050505081525050905080602001518160400151826060015183608001518460a001518560c001518660e00151876101200151969f50949d50929b5090995097509550935091505b50919395975091939597565b600f82810b900b600090815260208190526040902060050181805161150d92916020019061178e565b505b5050565b60018054600f81810b808401820b6001608060020a03166fffffffffffffffffffffffffffffffff1990931692909217835590810b900b60009081526020819052604081209091810186805161156d92916020019061178e565b506002810185805161158392916020019061178e565b506004810184805161159992916020019061178e565b50600581018380516115af92916020019061178e565b506003810180546fffffffffffffffffffffffffffffffff19166001608060020a0317905560006007820155600154600f0b91505b50949350505050565b60006115fb85858585611513565b600f87810b80820b600090815260208190526040808220600390810180546fffffffffffffffffffffffffffffffff199081166001608060020a0389890b8181169290921790935590960b8452919092209091018054909316911617905590505b505050505050565b600f82810b810b600090815260208190526040808220600390810180546001608060020a036fffffffffffffffffffffffffffffffff19918216811790925586860b90950b84529190922090910180549092161790555b5050565b81548183558181151161150d57600101600290048160010160029004836000526020600020918201910161150d919061180d565b5b505050565b610140604051908101604052600081526020810161171561176a565b815260200161172261176a565b81526000602082015260400161173661176a565b815260200161174361176a565b815260006020820181905260408201819052606082015260800161176561176a565b905290565b60206040519081016040526000815290565b60206040519081016040526000815290565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106117cf57805160ff19168380011785556117fc565b828001600101855582156117fc579182015b828111156117fc5782518255916020019190600101906117e1565b5b5061180992915061180d565b5090565b6110b791905b808211156118095760008155600101611813565b5090565b90565b60206040519081016040526000815290565b602060405190810160405260008152905600a165627a7a7230582075eb7dbd5a42e76f517b789a6582efe65aab9bd996255246231067c6d7ea05940029";
  
} 

initialize(){
  // this.familyTreeContract = contract({
  //   abi: this.familyTreeABI,
  //   unlinked_binary: this.familyTreeByteCode
  // })
  // this.familyTreeContract.setProvider(this.web3);
  this.familyTreeContract = this.web3.eth.contract(JSON.parse(this.familyTreeABI));
}
    
estimateGas (params) {
  const estimateGasAsync = (resolve, reject) => {
    this.web3.eth.estimateGas(
      params,
      (error, estimatedGas) => {
        if (error) {
          reject(error)
        } else {
          resolve(estimatedGas)
        }
      }
    )
  }
  return new Promise(estimateGasAsync)
}

findContract(contractAddress) {
  const findAsync = (resolve, reject) => {
    this.contract.at(contractAddress, (error, deployedContract) => {
      if (error)
        reject(error);
      else
        resolve(new FamilyTreeWrapper(deployedContract));
    });
  };
  return new Promise(findAsync);
}
newFamilyTree(name, gender, dob){
  console.log("contract; " + this.familyTreeContract)
  //this.familyTreeContract.new(name, gender, dob); 
  console.log("Deploying the contract");
  this.deployedContract = this.familyTreeContract.new(name, gender, dob, {from: web3.eth.coinbase, gas: 1000000, data: this.familyTreeByteCode}, (err, res) => {
    if (err) {
        console.log(err);
        return;
    }

    // Log the tx, you can explore status with eth.getTransaction()
    console.log(res.transactionHash);

    // If we have an address property, the contract was deployed
    if (res.address) {
        console.log('Contract address: ' + res.address);
        // Let's test the deployed contract
        testContract(res.address);
    }
});
 // console.log("Your contract is being deployed in transaction at " + this.deployedContract.transactionHash);
 // waitForContractToBeMined();
}
sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// We need to wait until any miner has included the transaction
// in a block to get the address of the contract
async waitForContractToBeMined() {
  while (true) {
    let receipt = web3.eth.getTransactionReceipt(deployedContract.transactionHash);
    if (receipt && receipt.contractAddress) {
      console.log("Your contract has been deployed at" + receipt.contractAddress);
      console.log("Note that it might take 30 - 90 sceonds for the block to propagate befor it's visible in etherscan.io");
      break;
    }
    console.log("Waiting a mined block to include your contract... currently in block " + web3.eth.blockNumber);
    await sleep(4000);
  }
}
}
//module.exports = FamilyTreeWrapper;